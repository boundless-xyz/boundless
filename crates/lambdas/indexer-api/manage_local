#!/bin/bash

# Script to manage local indexer and API for testing
set -e

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Load .env file if it exists
if [ -f .env ]; then
    echo "Loading environment variables from .env file..."
    set -a
    source .env
    set +a
fi

# Ethereum mainnet configuration
VEZKC_ADDRESS="${VEZKC_ADDRESS:-0xE8Ae8eE8ffa57F6a79B6Cbe06BAFc0b05F3ffbf4}"
ZKC_ADDRESS="${ZKC_ADDRESS:-0x000006c2A22ff4A44ff1f5d0F2ed65F781F55555}"
POVW_ACCOUNTING_ADDRESS="${POVW_ACCOUNTING_ADDRESS:-0x319bd4050b2170a7aE3Ead3E6d5AB8a5c7cFBDF8}"

# Function to display usage
usage() {
    echo "Usage: $0 <command> [options]"
    echo ""
    echo "Commands:"
    echo "  run-rewards-indexer <db_file> [duration] [end_epoch] [end_block] [batch_size]"
    echo "                                     Run rewards-indexer to populate SQLite database"
    echo "                                     duration: seconds to run (default: 120)"
    echo "                                     end_epoch: stop at this epoch (optional)"
    echo "                                     end_block: stop at this block (optional)"
    echo "                                     batch_size: blocks per batch (default: 500)"
    echo ""
    echo "  run-market-indexer <db_file> [duration] [start_block] [end_block] [batch_size]"
    echo "                                     Run market-indexer to populate SQLite database"
    echo "                                     duration: seconds to run (default: 120)"
    echo "                                     start_block: block to start from (optional)"
    echo "                                     end_block: stop at this block (optional)"
    echo "                                     batch_size: blocks per batch (default: 500)"
    echo ""
    echo "  run-api <port> <db_file>          Run API server with debug logging"
    echo ""
    echo "Environment variables (Rewards Indexer):"
    echo "  ZKC_RPC_URL                        Required: Ethereum RPC endpoint for ZKC/veZKC"
    echo "  VEZKC_ADDRESS                      Optional: veZKC contract address"
    echo "  ZKC_ADDRESS                        Optional: ZKC token address"
    echo "  POVW_ACCOUNTING_ADDRESS            Optional: PoVW accounting address"
    echo ""
    echo "Environment variables (Market Indexer):"
    echo "  MARKET_RPC_URL                     Required: RPC endpoint for Boundless Market"
    echo "  BOUNDLESS_MARKET_ADDRESS           Required: Boundless Market contract address"
    exit 1
}

# Function to check RPC URL
check_rpc_url() {
    local rpc_type="$1"  # Either "zkc" or "market"
    
    if [ "$rpc_type" == "zkc" ]; then
        if [ -z "$ZKC_RPC_URL" ]; then
            echo -e "${RED}Error: ZKC_RPC_URL environment variable is not set${NC}"
            echo "Please set it to your Ethereum RPC endpoint for ZKC/veZKC contracts"
            exit 1
        fi
    elif [ "$rpc_type" == "market" ]; then
        if [ -z "$MARKET_RPC_URL" ]; then
            echo -e "${RED}Error: MARKET_RPC_URL environment variable is not set${NC}"
            echo "Please set it to your RPC endpoint for Boundless Market"
            exit 1
        fi
        if [ -z "$BOUNDLESS_MARKET_ADDRESS" ]; then
            echo -e "${RED}Error: BOUNDLESS_MARKET_ADDRESS environment variable is not set${NC}"
            echo "Please set it to the Boundless Market contract address"
            exit 1
        fi
    fi
}

# Function to build binaries
build_binaries() {
    echo -e "${GREEN}Building required binaries...${NC}"
    cd ../../.. || exit 1

    if [ "$1" == "rewards-indexer" ] || [ "$1" == "both" ]; then
        echo "Building rewards-indexer..."
        cargo build -p boundless-indexer --bin rewards-indexer
    fi

    if [ "$1" == "market-indexer" ] || [ "$1" == "both" ]; then
        echo "Building market-indexer..."
        cargo build -p boundless-indexer --bin market-indexer
    fi

    if [ "$1" == "api" ] || [ "$1" == "both" ]; then
        echo "Building local-server..."
        cargo build -p indexer-api --bin local-server
    fi

    cd - > /dev/null || exit 1
}

# Function to run rewards indexer
run_rewards_indexer() {
    local db_file="$1"
    local duration="${2:-120}"
    local end_epoch="$3"
    local end_block="$4"
    local batch_size="$5"

    check_rpc_url "zkc"

    # Validate arguments
    if [ -z "$db_file" ]; then
        echo -e "${RED}Error: Database file path required${NC}"
        usage
    fi

    # Convert to absolute path if relative
    if [[ ! "$db_file" = /* ]]; then
        db_file="$(pwd)/$db_file"
    fi

    # Clean up existing database
    if [ -f "$db_file" ]; then
        echo -e "${YELLOW}Removing existing database: $db_file${NC}"
        rm "$db_file"
    fi

    # Create empty database file for SQLite
    echo -e "${GREEN}Creating SQLite database: $db_file${NC}"
    touch "$db_file"

    # Build the indexer
    build_binaries "rewards-indexer"

    echo -e "${GREEN}Running rewards-indexer for $duration seconds...${NC}"
    echo "Database: sqlite:$db_file"
    echo "RPC URL: $ZKC_RPC_URL"
    if [ ! -z "$end_epoch" ]; then
        echo "End epoch: $end_epoch"
    fi
    if [ ! -z "$end_block" ]; then
        echo "End block: $end_block"
    fi
    if [ ! -z "$batch_size" ]; then
        echo "Batch size: $batch_size"
    fi
    echo ""

    # Build command with optional parameters
    local cmd="../../../target/debug/rewards-indexer"
    cmd="$cmd --rpc-url \"$ZKC_RPC_URL\""
    cmd="$cmd --vezkc-address \"$VEZKC_ADDRESS\""
    cmd="$cmd --zkc-address \"$ZKC_ADDRESS\""
    cmd="$cmd --povw-accounting-address \"$POVW_ACCOUNTING_ADDRESS\""
    cmd="$cmd --db \"sqlite:$db_file\""
    cmd="$cmd --interval 600"

    if [ ! -z "$end_epoch" ]; then
        cmd="$cmd --end-epoch $end_epoch"
    fi
    if [ ! -z "$end_block" ]; then
        cmd="$cmd --end-block $end_block"
    fi
    if [ ! -z "$batch_size" ]; then
        cmd="$cmd --batch-size $batch_size"
    fi

    # Run the indexer in background
    DATABASE_URL="sqlite:$db_file" \
    VEZKC_ADDRESS="$VEZKC_ADDRESS" \
    ZKC_ADDRESS="$ZKC_ADDRESS" \
    POVW_ACCOUNTING_ADDRESS="$POVW_ACCOUNTING_ADDRESS" \
    RUST_LOG=info \
    eval "$cmd &"

    INDEXER_PID=$!

    # Show progress
    echo -n "Populating database"
    for i in $(seq 1 "$duration"); do
        if ! kill -0 $INDEXER_PID 2>/dev/null; then
            echo ""
            echo -e "${RED}Indexer stopped unexpectedly${NC}"
            exit 1
        fi
        sleep 1
        echo -n "."
    done
    echo ""

    # Stop the indexer
    if kill -0 $INDEXER_PID 2>/dev/null; then
        echo "Stopping indexer..."
        kill $INDEXER_PID 2>/dev/null || true
        wait $INDEXER_PID 2>/dev/null || true
    fi

    echo -e "${GREEN}Database populated successfully!${NC}"
    echo "Database location: $db_file"
}

# Function to run market indexer
run_market_indexer() {
    local db_file="$1"
    local duration="${2:-120}"
    local start_block="$3"
    local end_block="$4"
    local batch_size="$5"

    check_rpc_url "market"

    # Validate arguments
    if [ -z "$db_file" ]; then
        echo -e "${RED}Error: Database file path required${NC}"
        usage
    fi

    # Convert to absolute path if relative
    if [[ ! "$db_file" = /* ]]; then
        db_file="$(pwd)/$db_file"
    fi

    # Clean up existing database
    if [ -f "$db_file" ]; then
        echo -e "${YELLOW}Removing existing database: $db_file${NC}"
        rm "$db_file"
    fi

    # Create empty database file for SQLite
    echo -e "${GREEN}Creating SQLite database: $db_file${NC}"
    touch "$db_file"

    # Build the indexer
    build_binaries "market-indexer"

    echo -e "${GREEN}Running market-indexer for $duration seconds...${NC}"
    echo "Database: sqlite:$db_file"
    echo "RPC URL: $MARKET_RPC_URL"
    echo "Boundless Market Address: $BOUNDLESS_MARKET_ADDRESS"
    if [ ! -z "$start_block" ]; then
        echo "Start block: $start_block"
    fi
    if [ ! -z "$end_block" ]; then
        echo "End block: $end_block"
    fi
    if [ ! -z "$batch_size" ]; then
        echo "Batch size: $batch_size"
    fi
    echo ""

    # Build command with optional parameters
    local cmd="../../../target/debug/market-indexer"
    cmd="$cmd --rpc-url \"$MARKET_RPC_URL\""
    cmd="$cmd --boundless-market-address \"$BOUNDLESS_MARKET_ADDRESS\""
    cmd="$cmd --db \"sqlite:$db_file\""
    cmd="$cmd --interval 3"

    if [ ! -z "$start_block" ]; then
        cmd="$cmd --start-block $start_block"
    fi
    if [ ! -z "$end_block" ]; then
        cmd="$cmd --end-block $end_block"
    fi
    if [ ! -z "$batch_size" ]; then
        cmd="$cmd --batch-size $batch_size"
    fi

    # Run the indexer in background
    DATABASE_URL="sqlite:$db_file" \
    BOUNDLESS_MARKET_ADDRESS="$BOUNDLESS_MARKET_ADDRESS" \
    RUST_LOG=info \
    eval "$cmd &"

    INDEXER_PID=$!

    # Show progress
    echo -n "Populating database"
    for i in $(seq 1 "$duration"); do
        if ! kill -0 $INDEXER_PID 2>/dev/null; then
            echo ""
            echo -e "${RED}Indexer stopped unexpectedly${NC}"
            exit 1
        fi
        sleep 1
        echo -n "."
    done
    echo ""

    # Stop the indexer
    if kill -0 $INDEXER_PID 2>/dev/null; then
        echo "Stopping indexer..."
        kill $INDEXER_PID 2>/dev/null || true
        wait $INDEXER_PID 2>/dev/null || true
    fi

    echo -e "${GREEN}Database populated successfully!${NC}"
    echo "Database location: $db_file"
}

# Function to run API
run_api() {
    local port="$1"
    local db_file="$2"

    # Validate arguments
    if [ -z "$port" ] || [ -z "$db_file" ]; then
        echo -e "${RED}Error: Port and database file required${NC}"
        usage
    fi

    # Convert to absolute path if relative
    if [[ ! "$db_file" = /* ]]; then
        db_file="$(pwd)/$db_file"
    fi

    # Check if database exists
    if [ ! -f "$db_file" ]; then
        echo -e "${RED}Error: Database file not found: $db_file${NC}"
        echo "Run 'manage_local run-rewards-indexer' or 'manage_local run-market-indexer' first to create and populate the database"
        exit 1
    fi

    # Build the API server
    build_binaries "api"

    echo -e "${GREEN}Starting API server...${NC}"
    echo "Port: $port"
    echo "Database: sqlite:$db_file"
    echo ""
    echo "http://localhost:$port/docs"
    echo ""

    DB_URL="sqlite:$db_file" \
    PORT="$port" \
    RUST_LOG=debug \
    ../../../target/debug/local-server
}

# Main script logic
if [ $# -lt 1 ]; then
    usage
fi

COMMAND="$1"
shift

case "$COMMAND" in
    run-rewards-indexer)
        run_rewards_indexer "$@"
        ;;
    run-market-indexer)
        run_market_indexer "$@"
        ;;
    run-api)
        run_api "$@"
        ;;
    *)
        echo -e "${RED}Unknown command: $COMMAND${NC}"
        usage
        ;;
esac