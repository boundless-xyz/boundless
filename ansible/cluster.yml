---
# Boundless Prover Deployment Playbook
#
# This playbook deploys a complete Boundless prover stack including:
# - AWS CLI (for AWS operations and Vector log shipping)
# - NVIDIA drivers and CUDA Toolkit (for GPU workers)
# - PostgreSQL database
# - Valkey (Redis-compatible) cache
# - MinIO object storage
# - Bento proving agents (prove, execute, aux, api)
# - Broker service
# - Miner service
# - Vector log shipping (disabled by default)
#
# Usage:
#   ansible-playbook -i inventory.yml cluster.yml
#
# Required Variables:
#   See host_vars and group_vars for configuration options.
#   Sensitive values should be set in vault files or via -e flags.
#
- name: Deploy Boundless Prover
  hosts: all
  become: true
  gather_facts: true

  tasks:
    # Install AWS CLI (required for Vector log shipping and other AWS operations)
    - name: Install AWS CLI
      ansible.builtin.include_role:
        name: awscli
      tags:
        - awscli
        - bento-deps

    # Install NVIDIA drivers and CUDA (required for GPU workers)
    - name: Install NVIDIA drivers and CUDA
      ansible.builtin.include_role:
        name: nvidia
      tags:
        - nvidia
        - bento-deps

    # Dependencies - only run if bento_install_dependencies is true
    - name: Deploy PostgreSQL
      ansible.builtin.include_role:
        name: postgresql
      tags:
        - bento-deps
        - postgresql

    - name: Deploy Valkey
      ansible.builtin.include_role:
        name: valkey
      tags:
        - bento-deps
        - valkey

    - name: Deploy MinIO
      ansible.builtin.include_role:
        name: minio
      tags:
        - bento-deps
        - minio

    # Bento services
    - name: Deploy Bento
      ansible.builtin.include_role:
        name: bento
      vars:
        bento_task: "prove"
        bento_install_dependencies: false
        bento_count: "{{ bento_gpu_count }}"
      tags:
        - bento
        - bento-prove

    - name: Deploy Bento API
      ansible.builtin.include_role:
        name: bento
      vars:
        bento_task: "api"
        bento_install_dependencies: false
      tags:
        - bento
        - bento-api

    - name: Deploy Bento Execute
      ansible.builtin.include_role:
        name: bento
      vars:
        bento_task: "exec"
        bento_install_dependencies: false
        bento_count: "{{ bento_exec_count }}"
      tags:
        - bento
        - bento-exec

    - name: Deploy Bento Aux
      ansible.builtin.include_role:
        name: bento
      vars:
        bento_task: "aux"
        bento_install_dependencies: false
        bento_count: "{{ bento_aux_count }}"
      tags:
        - bento
        - bento-aux

    - name: Deploy Bento Snark Worker
      ansible.builtin.include_role:
        name: bento
      vars:
        bento_task: "snark"
        bento_install_dependencies: false
        bento_count: "{{ bento_snark_count }}"
      when:
        - bento_snark_workers | bool
      tags:
        - bento
        - bento-snark

    - name: Deploy Bento Join Worker
      ansible.builtin.include_role:
        name: bento
      vars:
        bento_task: "join"
        bento_install_dependencies: false
        bento_count: "{{ bento_join_count }}"
      when:
        - bento_join_workers | bool
      tags:
        - bento
        - bento-join

    - name: Deploy Broker
      ansible.builtin.include_role:
        name: broker
      tags:
        - broker

    - name: Deploy Miner
      ansible.builtin.include_role:
        name: miner
      tags:
        - miner

    - name: Deploy Vector (log shipping)
      ansible.builtin.include_role:
        name: vector
      tags:
        - vector
