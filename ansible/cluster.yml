---
# Boundless Prover Deployment Playbook
#
# This playbook deploys a complete Boundless prover stack including:
# - PostgreSQL database
# - Valkey (Redis-compatible) cache
# - MinIO object storage
# - Bento proving agents (prove, execute, aux, api)
# - Broker service
#
# Usage:
#   ansible-playbook -i inventory.yml cluster.yml
#
# Required Variables:
#   See validation task below for required variables and setup instructions.
#
- name: Deploy Boundless Prover
  hosts: all
  become: true
  gather_facts: true

  tasks:
    # Install NVIDIA drivers and CUDA (required for GPU workers)
    - name: Install NVIDIA drivers and CUDA
      ansible.builtin.include_role:
        name: nvidia
      tags:
        - nvidia
        - bento-deps

    # Dependencies - only run if bento_install_dependencies is true
    - name: Deploy PostgreSQL
      ansible.builtin.include_role:
        name: postgresql
      tags:
        - bento-deps
        - postgresql

    - name: Deploy Valkey
      ansible.builtin.include_role:
        name: valkey
      tags:
        - bento-deps
        - valkey

    - name: Deploy MinIO
      ansible.builtin.include_role:
        name: minio
      tags:
        - bento-deps
        - minio

    # Bento services
    - name: Deploy Bento
      ansible.builtin.include_role:
        name: bento
      vars:
        bento_task: "prove"
        bento_install_dependencies: false
        bento_count: "{{ bento_gpu_count }}"
      tags:
        - bento
        - bento-prove

    - name: Deploy Bento API
      ansible.builtin.include_role:
        name: bento
      vars:
        bento_task: "api"
        bento_install_dependencies: false
      tags:
        - bento
        - bento-api

    - name: Deploy Bento Execute
      ansible.builtin.include_role:
        name: bento
      vars:
        bento_task: "exec"
        bento_install_dependencies: false
        bento_count: "{{ bento_exec_count }}"
      tags:
        - bento
        - bento-exec

    - name: Deploy Bento Aux
      ansible.builtin.include_role:
        name: bento
      vars:
        bento_task: "aux"
        bento_install_dependencies: false
        bento_count: "{{ bento_aux_count }}"
      tags:
        - bento
        - bento-aux

    - name: Deploy Broker
      ansible.builtin.include_role:
        name: broker
      tags:
        - broker

    - name: Deploy Miner
      ansible.builtin.include_role:
        name: miner
      tags:
        - miner

    - name: Deploy Vector (log shipping)
      ansible.builtin.include_role:
        name: vector
      tags:
        - vector
