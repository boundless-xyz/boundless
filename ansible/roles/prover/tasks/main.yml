---
# Main tasks for bento role
- name: Clone the Bento repository
  ansible.builtin.git:
    repo: https://github.com/boundless-xyz/boundless.git
    dest: "{{ prover_dir }}"
    version: "{{ prover_version }}"
    recursive: true
    force: true
  notify: Restart Bento

- name: Generate Docker Compose environment file
  ansible.builtin.template:
    src: docker-compose.env.j2
    dest: "{{ prover_env_file }}"
    owner: root
    group: root
    mode: '0600'
  notify: Restart Bento

- name: Download broker configuration file
  ansible.builtin.get_url:
    url: '{{ prover_broker_toml_url }}'
    dest: "{{ prover_dir }}/broker.toml"
    owner: root
    group: root
    mode: '0644'
  notify: Restart Bento

- name: Download pricing overrides file (creates default if missing)
  ansible.builtin.get_url:
    url: '{{ prover_pricing_overrides_url }}'
    dest: "{{ prover_dir }}/pricing-overrides.json"
    owner: root
    group: root
    mode: '0644'
    force: false

- name: Write the system service file
  ansible.builtin.template:
    src: bento.service.j2
    dest: /etc/systemd/system/bento.service
    owner: root
    group: root
    mode: '0644'
  notify:
    - Reload systemd
    - Restart Bento

- name: Ensure Bento service is enabled and started
  ansible.builtin.systemd:
    name: bento
    enabled: true
    state: started
    daemon_reload: true

- name: Wait for MinIO to be ready
  ansible.builtin.uri:
    url: "http://127.0.0.1:9000/minio/health/live"
    method: GET
    status_code: 200
    timeout: 5
  register: prover_minio_health
  until: prover_minio_health.status == 200
  retries: 12
  delay: 5
  when: prover_minio_work_expiry_days | int > 0

- name: Get current MinIO lifecycle rules
  ansible.builtin.shell: |
    docker run --rm --network host --entrypoint /bin/sh \
      -e MC_USER="{{ prover_minio_root_user }}" \
      -e MC_PASS="{{ prover_minio_root_pass }}" \
      -e MC_BUCKET="{{ prover_minio_bucket }}" \
      minio/mc:latest -c '
      mc alias set proverminio http://127.0.0.1:9000 "$MC_USER" "$MC_PASS" &&
      mc ilm export proverminio/$MC_BUCKET 2>/dev/null || true
    '
  register: prover_minio_ilm_current
  when: prover_minio_work_expiry_days | int > 0
  changed_when: false
  no_log: true

- name: Configure MinIO lifecycle to expire workflow objects after configured days
  ansible.builtin.shell: |
    docker run --rm --network host --entrypoint /bin/sh \
      -e MC_USER="{{ prover_minio_root_user }}" \
      -e MC_PASS="{{ prover_minio_root_pass }}" \
      -e MC_BUCKET="{{ prover_minio_bucket }}" \
      -e EXPIRE_DAYS="{{ prover_minio_work_expiry_days }}" \
      minio/mc:latest -c '
      mc alias set proverminio http://127.0.0.1:9000 "$MC_USER" "$MC_PASS" &&
      mc ilm rule add proverminio/$MC_BUCKET --expire-days "$EXPIRE_DAYS"
    '
  when:
    - prover_minio_work_expiry_days | int > 0
    - (prover_minio_work_expiry_days | string) not in (prover_minio_ilm_current.stdout | default(''))
  changed_when: true
  no_log: true
