---
- name: Install MinIO
  when: minio_install | bool
  block:
    - name: Create MinIO group
      ansible.builtin.group:
        name: "{{ minio_group }}"
        state: present
        system: true

    - name: Create MinIO user
      ansible.builtin.user:
        name: "{{ minio_user }}"
        group: "{{ minio_group }}"
        home: "{{ minio_home }}"
        shell: "{{ minio_shell }}"
        system: true
        create_home: true
        state: present

    - name: Create MinIO directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "{{ minio_user }}"
        group: "{{ minio_group }}"
        mode: '0755'
      loop:
        - "{{ minio_home }}"
        - "{{ minio_data_dir }}"
        - "{{ minio_config_dir }}"
        - "{{ minio_log_dir }}"

    - name: Check if MinIO binary exists
      ansible.builtin.stat:
        path: "{{ minio_install_dir }}/{{ minio_binary_name }}"
      register: minio_binary_stat

    - name: Create temporary directory for MinIO download
      ansible.builtin.file:
        path: /tmp/minio-install
        state: directory
        mode: '0755'
      when: not minio_binary_stat.stat.exists

    - name: Download MinIO server binary checksum
      ansible.builtin.get_url:
        url: "https://dl.min.io/server/minio/release/linux-amd64/minio.sha256sum"
        dest: /tmp/minio-install/minio.sha256sum
        mode: '0644'
      register: minio_checksum_download
      ignore_errors: true
      failed_when: false
      when: not minio_binary_stat.stat.exists

    - name: Download MinIO server binary
      ansible.builtin.get_url:
        url: "https://dl.min.io/server/minio/release/linux-amd64/minio"
        dest: /tmp/minio-install/minio
        mode: '0755'
      when: not minio_binary_stat.stat.exists

    - name: Extract expected checksum from checksum file
      ansible.builtin.shell: |
        set -o pipefail
        if [ -f /tmp/minio-install/minio.sha256sum ]; then
          cut -d' ' -f1 /tmp/minio-install/minio.sha256sum
        else
          echo ""
        fi
      args:
        executable: /bin/bash
      register: minio_expected_checksum
      changed_when: false
      failed_when: false
      when:
        - not minio_binary_stat.stat.exists
        - minio_checksum_download is succeeded

    - name: Verify MinIO binary checksum
      ansible.builtin.shell: |
        set -o pipefail
        expected_checksum="{{ minio_expected_checksum.stdout }}"
        actual_checksum=$(sha256sum /tmp/minio-install/minio | cut -d' ' -f1)
        if [ "$expected_checksum" = "$actual_checksum" ]; then
          echo "Checksum verified: $actual_checksum"
          exit 0
        else
          echo "Checksum mismatch!"
          echo "Expected: $expected_checksum"
          echo "Actual: $actual_checksum"
          exit 1
        fi
      args:
        executable: /bin/bash
      register: minio_checksum_result
      failed_when: minio_checksum_result.rc != 0
      changed_when: false
      when:
        - not minio_binary_stat.stat.exists
        - minio_checksum_download is succeeded
        - minio_expected_checksum.stdout | length > 0

    - name: Warn about missing checksum verification
      ansible.builtin.debug:
        msg: "WARNING: Checksum file not available for MinIO. Binary integrity not verified. Consider verifying manually."
      when:
        - not minio_binary_stat.stat.exists
        - minio_checksum_download is failed or minio_expected_checksum.stdout | length == 0

    - name: Install MinIO server binary
      ansible.builtin.copy:
        src: /tmp/minio-install/minio
        dest: "{{ minio_install_dir }}/{{ minio_binary_name }}"
        mode: '0755'
        owner: root
        group: root
        remote_src: true
      when: not minio_binary_stat.stat.exists

    - name: Clean up MinIO temporary files
      ansible.builtin.file:
        path: /tmp/minio-install
        state: absent
      when: not minio_binary_stat.stat.exists

    - name: Configure MinIO environment file
      ansible.builtin.template:
        src: minio.env.j2
        dest: "{{ minio_config_dir }}/minio.env"
        mode: '0640'
        owner: root
        group: "{{ minio_group }}"
      notify: Restart MinIO service

    - name: Configure MinIO systemd service
      ansible.builtin.template:
        src: minio.service.j2
        dest: /etc/systemd/system/minio.service
        mode: '0644'
        owner: root
        group: root
      notify:
        - Reload systemd
        - Restart MinIO service
      tags:
        - minio
        - minio-config

    - name: Ensure MinIO service is enabled and started
      ansible.builtin.systemd:
        name: minio.service
        enabled: "{{ minio_service_enabled }}"
        state: "{{ minio_service_state }}"
        daemon_reload: true

    - name: Wait for MinIO to be ready
      ansible.builtin.wait_for:
        host: "{{ minio_host }}"
        port: "{{ minio_port }}"
        delay: 5
        timeout: 60
      when: minio_service_state == "started"

    - name: Configure MinIO lifecycle expiration
      when: minio_lifecycle_expire_days is defined and minio_lifecycle_expire_days | int > 0
      block:
        - name: Check if MinIO client (mc) is installed
          ansible.builtin.stat:
            path: "{{ minio_install_dir }}/mc"
          register: minio_client_stat

        - name: Download MinIO client binary
          ansible.builtin.get_url:
            url: "https://dl.min.io/client/mc/release/linux-amd64/mc"
            dest: "{{ minio_install_dir }}/mc"
            mode: '0755'
          when: not minio_client_stat.stat.exists

        - name: Create MinIO client config directory
          ansible.builtin.file:
            path: "{{ minio_home }}/.mc"
            state: directory
            owner: "{{ minio_user }}"
            group: "{{ minio_group }}"
            mode: '0755'

        - name: Configure MinIO client alias
          ansible.builtin.shell: |
            {{ minio_install_dir }}/mc alias set local http://{{ minio_host }}:{{ minio_port }} {{ minio_root_user }} {{ minio_root_password }}
          environment:
            HOME: "{{ minio_home }}"
          changed_when: false
          failed_when: false
          register: minio_alias_result

        - name: Check if bucket exists
          ansible.builtin.shell: |
            {{ minio_install_dir }}/mc ls local/{{ minio_lifecycle_bucket }} > /dev/null 2>&1
          environment:
            HOME: "{{ minio_home }}"
          register: minio_bucket_check
          changed_when: false
          failed_when: false

        - name: Create bucket if it doesn't exist
          ansible.builtin.command:
            cmd: "{{ minio_install_dir }}/mc mb local/{{ minio_lifecycle_bucket }}"
          environment:
            HOME: "{{ minio_home }}"
          when: minio_bucket_check.rc != 0
          register: minio_bucket_result
          failed_when: false
          changed_when: minio_bucket_result.rc == 0

        - name: Check existing lifecycle rules
          ansible.builtin.shell: |
            {{ minio_install_dir }}/mc ilm list local/{{ minio_lifecycle_bucket }} 2>/dev/null || echo ""
          environment:
            HOME: "{{ minio_home }}"
          register: minio_existing_lifecycle
          changed_when: false
          failed_when: false

        - name: Check if lifecycle policy matches desired configuration
          ansible.builtin.set_fact:
            minio_lifecycle_needs_update: >-
              {{
                minio_existing_lifecycle.stdout is not defined or
                minio_existing_lifecycle.stdout | length == 0 or
                minio_lifecycle_expire_days | string not in minio_existing_lifecycle.stdout
              }}

        - name: Remove existing lifecycle rules (if any)
          ansible.builtin.command:
            cmd: "{{ minio_install_dir }}/mc ilm clear local/{{ minio_lifecycle_bucket }}"
          environment:
            HOME: "{{ minio_home }}"
          when:
            - minio_existing_lifecycle.stdout | length > 0
            - minio_lifecycle_needs_update | bool
          register: minio_clear_result
          changed_when: minio_clear_result.rc == 0
          failed_when: false

        - name: Configure MinIO lifecycle expiration policy
          ansible.builtin.command:
            cmd: >-
              {{ minio_install_dir }}/mc ilm add local/{{ minio_lifecycle_bucket }}
              --expiry-days {{ minio_lifecycle_expire_days }}
          environment:
            HOME: "{{ minio_home }}"
          register: minio_lifecycle_result
          changed_when: minio_lifecycle_result.rc == 0
          failed_when: minio_lifecycle_result.rc != 0
          when: minio_lifecycle_needs_update | bool
          tags:
            - minio
            - minio-lifecycle

        - name: Display lifecycle configuration
          ansible.builtin.debug:
            msg: "MinIO lifecycle policy configured: objects in bucket '{{ minio_lifecycle_bucket }}' will expire after {{ minio_lifecycle_expire_days }} days"
          when: minio_lifecycle_result.rc == 0
