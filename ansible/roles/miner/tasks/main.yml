---
- name: Check if Miner binary (bento_cli) exists
  ansible.builtin.stat:
    path: "{{ miner_install_dir }}/bento_cli"
  register: miner_binary_check
  tags:
    - miner
    - miner-install

- name: Verify bento_cli is installed (should be installed by Bento role)
  ansible.builtin.assert:
    that:
      - miner_binary_check.stat.exists
    fail_msg: "bento_cli binary not found. The Bento role should install it from the bundle. Please ensure the Bento role runs before the Miner role."
    success_msg: "bento_cli binary found, ready for miner service"
  tags:
    - miner
    - miner-install

- name: Configure Miner systemd service
  ansible.builtin.template:
    src: miner.service.j2
    dest: /etc/systemd/system/miner.service
    mode: '0644'
    owner: root
    group: root
  notify:
    - Reload systemd
    - Restart Miner service
  tags:
    - miner
    - miner-config

- name: Ensure Miner service is enabled and started
  ansible.builtin.systemd:
    name: miner.service
    enabled: "{{ miner_service_enabled }}"
    state: "{{ miner_service_state }}"
    daemon_reload: true
  tags:
    - miner
    - miner-service
