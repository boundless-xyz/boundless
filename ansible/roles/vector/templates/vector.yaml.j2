sources:
  journald:
    type: journald
    include_units:
{% for service in vector_monitor_services %}
      - {{ service }}
{% endfor %}

{% if vector_collect_host_metrics | bool %}
  host_metrics:
    type: host_metrics
    collectors:
{% for collector in vector_host_metrics_collectors %}
      - {{ collector }}
{% endfor %}
    scrape_interval_secs: {{ vector_metrics_scrape_interval }}
{% if "filesystem" in vector_host_metrics_collectors %}
    filesystem:
{% if vector_filesystem_devices_includes is defined and vector_filesystem_devices_includes | length > 0 %}
      devices:
        includes:
{% for device in vector_filesystem_devices_includes %}
          - {{ device }}
{% endfor %}
{% endif %}
{% if vector_filesystem_devices_excludes is defined and vector_filesystem_devices_excludes | length > 0 %}
      devices:
        excludes:
{% for device in vector_filesystem_devices_excludes %}
          - {{ device }}
{% endfor %}
{% endif %}
{% if vector_filesystem_mountpoints_includes is defined and vector_filesystem_mountpoints_includes | length > 0 %}
      mountpoints:
        includes:
{% for mountpoint in vector_filesystem_mountpoints_includes %}
          - {{ mountpoint }}
{% endfor %}
{% endif %}
{% if vector_filesystem_mountpoints_excludes is defined and vector_filesystem_mountpoints_excludes | length > 0 %}
      mountpoints:
        excludes:
{% for mountpoint in vector_filesystem_mountpoints_excludes %}
          - {{ mountpoint }}
{% endfor %}
{% endif %}
{% endif %}
{% endif %}

{% if vector_track_bento_process | default(true) | bool %}
  exec_bento_active:
    type: exec
    mode: scheduled
    scheduled:
      exec_interval_secs: {{ vector_bento_process_interval_secs | default(60) }}
    command: ["/bin/sh", "-c", "/usr/bin/systemctl is-active bento 2>/dev/null | grep -q active && echo 1 || echo 0"]
  exec_bento_containers:
    type: exec
    mode: scheduled
    scheduled:
      exec_interval_secs: {{ vector_bento_process_interval_secs | default(60) }}
    command: ["/bin/sh", "-c", "PATH=/usr/bin:/bin docker ps -q --filter label=com.docker.compose.project=bento 2>/dev/null | wc -l"]
{% endif %}

{% if vector_track_kailua_process | default(false) | bool %}
  exec_kailua_active:
    type: exec
    mode: scheduled
    scheduled:
      exec_interval_secs: {{ vector_kailua_process_interval_secs | default(60) }}
    command: ["/bin/sh", "-c", "/usr/bin/systemctl is-active kailua 2>/dev/null | grep -q active && echo 1 || echo 0"]
  exec_kailua_log_age:
    type: exec
    mode: scheduled
    scheduled:
      exec_interval_secs: {{ vector_kailua_process_interval_secs | default(60) }}
    command: ["/bin/sh", "-c", "l=$(journalctl -u kailua.service --no-pager -o short-unix -n 1 -q 2>/dev/null | awk '{print int($1)}'); n=$(date +%s); [ -z \"$l\" ] || [ \"$l\" -le 0 ] && echo 999999 || echo $((n-l))"]
{% endif %}

transforms:
  extract_message:
    type: remap
    inputs: ["journald"]
    source: |
      . = .message

{% if vector_track_bento_process | default(true) | bool %}
  parse_bento_active:
    type: remap
    inputs: ["exec_bento_active"]
    source: |
      .value = to_int(string!(.message)) ?? 0
  parse_bento_containers:
    type: remap
    inputs: ["exec_bento_containers"]
    source: |
      .value = to_int(string!(.message)) ?? 0
  bento_active_gauge:
    type: log_to_metric
    inputs: ["parse_bento_active"]
    metrics:
      - type: gauge
        field: value
        name: bento_active
        kind: absolute
  bento_containers_gauge:
    type: log_to_metric
    inputs: ["parse_bento_containers"]
    metrics:
      - type: gauge
        field: value
        name: bento_containers
        kind: absolute
{% endif %}

{% if vector_track_kailua_process | default(false) | bool %}
  parse_kailua_active:
    type: remap
    inputs: ["exec_kailua_active"]
    source: |
      .value = to_int(string!(.message)) ?? 0
  parse_kailua_log_age:
    type: remap
    inputs: ["exec_kailua_log_age"]
    source: |
      .value = to_int(string!(.message)) ?? 999999
  kailua_active_gauge:
    type: log_to_metric
    inputs: ["parse_kailua_active"]
    metrics:
      - type: gauge
        field: value
        name: kailua_active
        kind: absolute
  kailua_log_age_gauge:
    type: log_to_metric
    inputs: ["parse_kailua_log_age"]
    metrics:
      - type: gauge
        field: value
        name: kailua_log_age_secs
        kind: absolute
{% endif %}

{% if vector_track_log_errors | default(true) | bool %}
  filter_log_errors:
    type: filter
    inputs: ["journald"]
    condition: 'contains(to_string(.message) ?? "", "ERROR")'
  bento_log_errors_counter:
    type: log_to_metric
    inputs: ["filter_log_errors"]
    metrics:
      - type: counter
        field: message
        name: bento_log_errors
{% endif %}

sinks:
  cloudwatch_bento:
    type: aws_cloudwatch_logs
    inputs: ["extract_message"]
    group_name: "{{ vector_cloudwatch_log_group }}"
    stream_name: "{{ vector_cloudwatch_stream_name }}"
    region: "{{ vector_cloudwatch_region }}"
    encoding:
      codec: json
    buffer:
      type: "{{ vector_buffer_type }}"
      max_size: {{ vector_buffer_max_size }}
      when_full: "{{ vector_buffer_when_full }}"

{% if vector_collect_host_metrics | bool or vector_track_bento_process | default(true) | bool or vector_track_kailua_process | default(false) | bool or vector_track_log_errors | default(true) | bool %}
  cloudwatch_metrics:
    type: aws_cloudwatch_metrics
    inputs:
{% if vector_collect_host_metrics | bool %}
      - host_metrics
{% endif %}
{% if vector_track_bento_process | default(true) | bool %}
      - bento_active_gauge
      - bento_containers_gauge
{% endif %}
{% if vector_track_kailua_process | default(false) | bool %}
      - kailua_active_gauge
      - kailua_log_age_gauge
{% endif %}
{% if vector_track_log_errors | default(true) | bool %}
      - bento_log_errors_counter
{% endif %}
    default_namespace: "{{ vector_cloudwatch_metrics_namespace }}"
    region: "{{ vector_cloudwatch_region }}"
    buffer:
      type: "{{ vector_buffer_type }}"
      max_size: {{ vector_buffer_max_size }}
      when_full: "{{ vector_buffer_when_full }}"
{% endif %}

