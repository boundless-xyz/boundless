---
- name: Install Vector
  when: vector_install | bool
  block:
    - name: Check if Vector is already installed
      ansible.builtin.command:
        cmd: which vector
      register: vector_installed_check
      changed_when: false
      failed_when: false
      ignore_errors: true

    - name: Download Vector setup script
      ansible.builtin.get_url:
        url: https://setup.vector.dev
        dest: /tmp/vector-setup.sh
        mode: '0755'
      when: vector_installed_check.rc != 0

    - name: Run Vector setup script
      ansible.builtin.command:
        cmd: /bin/bash /tmp/vector-setup.sh
      args:
        creates: /usr/bin/vector
      when: vector_installed_check.rc != 0
      register: vector_setup_result
      changed_when: vector_setup_result.rc == 0
      failed_when: vector_setup_result.rc != 0

    - name: Clean up Vector setup script
      ansible.builtin.file:
        path: /tmp/vector-setup.sh
        state: absent
      when: vector_installed_check.rc != 0

    - name: Install Vector package
      ansible.builtin.apt:
        name: vector
        state: present
        update_cache: true
      when: vector_installed_check.rc != 0
      notify: Reload systemd

- name: Create Vector configuration directory
  ansible.builtin.file:
    path: "{{ vector_config_dir }}"
    state: directory
    mode: '0755'
    owner: root
    group: root
  tags:
    - vector
    - vector-config

- name: Configure Vector
  ansible.builtin.template:
    src: vector.yaml.j2
    dest: "{{ vector_config_file }}"
    mode: '0644'
    owner: root
    group: root
  notify: Restart Vector service
  tags:
    - vector
    - vector-config

- name: Configure Vector environment
  ansible.builtin.lineinfile:
    path: /etc/default/vector
    regexp: '^VECTOR_LOG='
    line: "VECTOR_LOG={{ vector_log_level }}"
    create: true
    mode: '0644'
  notify: Restart Vector service
  tags:
    - vector
    - vector-config

- name: Ensure Vector service is configured
  ansible.builtin.systemd:
    name: vector.service
    enabled: "{{ vector_service_enabled }}"
    state: "{{ vector_service_state }}"
    daemon_reload: true
  tags:
    - vector
    - vector-service
