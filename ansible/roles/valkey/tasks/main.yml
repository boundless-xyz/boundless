---
- name: Install Valkey (Redis fork)
  when: valkey_install | bool
  block:
    - name: Install Valkey server
      ansible.builtin.apt:
        name: valkey-server
        state: present
        update_cache: true

    - name: Configure Valkey
      ansible.builtin.template:
        src: valkey.conf.j2
        dest: /etc/valkey/valkey.conf
        mode: '0644'
        owner: root
        group: root
      notify: Restart Valkey service
      tags:
        - valkey
        - valkey-config

    - name: Ensure Valkey service is enabled and started
      ansible.builtin.systemd:
        name: valkey-server
        enabled: "{{ valkey_service_enabled }}"
        state: "{{ valkey_service_state }}"
