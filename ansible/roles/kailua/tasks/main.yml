---
- name: Install Kailua binary from release (source)
  when: kailua_install_method == "source"
  block:
    - name: Download Kailua binary
      ansible.builtin.get_url:
        url: "{{ kailua_download_url }}"
        dest: "/tmp/{{ kailua_archive }}"
        mode: "0644"

    - name: Extract Kailua binary
      ansible.builtin.unarchive:
        src: "/tmp/{{ kailua_archive }}"
        dest: "{{ kailua_install_dir }}"
        mode: "0755"
        remote_src: true

    - name: Remove Kailua archive
      ansible.builtin.file:
        path: "/tmp/{{ kailua_archive }}"
        state: absent

- name: Ensure Kailua data directory exists
  ansible.builtin.file:
    path: "{{ kailua_demo_data_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  when:
    - kailua_install_service | bool
    - kailua_demo_data_dir | default("") | string | length > 0

- name: Write Kailua launcher script
  ansible.builtin.template:
    src: kailua_launcher.sh.j2
    dest: "{{ kailua_launcher_path }}"
    owner: root
    group: root
    mode: "0755"
  when: kailua_install_service | bool
  notify: Restart Kailua

- name: Write Kailua service file
  ansible.builtin.template:
    src: kailua.service.j2
    dest: /etc/systemd/system/kailua.service
    owner: root
    group: root
    mode: "0644"
  when: kailua_install_service | bool
  notify:
    - Reload systemd
    - Restart Kailua

- name: Ensure Kailua service is enabled and started
  ansible.builtin.systemd:
    name: kailua
    enabled: true
    state: started
    daemon_reload: true
  when: kailua_install_service | bool
