---
- name: Check if Broker user exists
  ansible.builtin.getent:
    database: passwd
    key: "{{ broker_user }}"
  register: broker_user_check
  changed_when: false
  failed_when: false
  ignore_errors: true

- name: Create Broker group
  ansible.builtin.group:
    name: "{{ broker_group }}"
    state: present
    system: true

- name: Create Broker user
  ansible.builtin.user:
    name: "{{ broker_user }}"
    group: "{{ broker_group }}"
    home: "{{ broker_home }}"
    shell: "{{ broker_shell }}"
    system: true
    create_home: true
    comment: "Boundless Broker service user"
  when: >
    broker_user_check.ansible_facts.getent_passwd is not defined or
    broker_user not in (broker_user_check.ansible_facts.getent_passwd | default({}))

- name: Check if Broker binary is already installed
  ansible.builtin.stat:
    path: "{{ broker_install_dir }}/broker"
  register: broker_binary_check

- name: Install Broker
  when: not broker_binary_check.stat.exists
  block:
    - name: Download Broker binary
      ansible.builtin.get_url:
        url: "https://github.com/boundless-xyz/boundless/releases/download/broker-{{ broker_version }}/broker"
        dest: /tmp/broker
        mode: '0755'
        timeout: 300

    - name: Install Broker binary
      ansible.builtin.copy:
        src: /tmp/broker
        dest: "{{ broker_install_dir }}/broker"
        mode: '0755'
        owner: root
        group: root
        remote_src: true
      notify: Reload systemd

    - name: Clean up Broker binary
      ansible.builtin.file:
        path: /tmp/broker
        state: absent

    - name: Clean up Broker checksum
      ansible.builtin.file:
        path: /tmp/broker.sha256
        state: absent

- name: Create Broker home directory
  ansible.builtin.file:
    path: "{{ broker_home }}"
    state: directory
    mode: '0750'
    owner: "{{ broker_user }}"
    group: "{{ broker_group }}"

- name: Create Broker configuration directory
  ansible.builtin.file:
    path: "{{ broker_config_dir }}"
    state: directory
    mode: '0750'
    owner: "{{ broker_user }}"
    group: "{{ broker_group }}"

- name: Create Broker working directory
  ansible.builtin.file:
    path: "{{ broker_work_dir }}"
    state: directory
    mode: '0750'
    owner: "{{ broker_user }}"
    group: "{{ broker_group }}"

- name: Set database URL based on type
  ansible.builtin.set_fact:
    broker_db_url_final: "{{ broker_db_url }}"
  when: broker_db_type == "sqlite"

- name: Create Broker configuration file
  ansible.builtin.template:
    src: broker.toml.j2
    dest: "{{ broker_config_file }}"
    mode: '0640'
    owner: "{{ broker_user }}"
    group: "{{ broker_group }}"
  notify: Restart Broker service

- name: Create Broker service file
  ansible.builtin.template:
    src: broker.service.j2
    dest: "/etc/systemd/system/broker.service"
    mode: '0644'
    owner: root
    group: root
  notify:
    - Reload systemd
    - Restart Broker service

- name: Ensure Broker service is enabled and started
  ansible.builtin.systemd:
    name: broker
    enabled: "{{ broker_service_enabled }}"
    state: "{{ broker_service_state }}"
    daemon_reload: true
  when: broker_service_state != "stopped"
