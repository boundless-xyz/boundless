---
- name: Get user home directory
  ansible.builtin.shell: |
    set -o pipefail
    getent passwd {{ rust_user }} | cut -d: -f6
  args:
    executable: /bin/bash
  register: rust_user_home_result
  changed_when: false
  when: rust_home is none
  tags:
    - rust
    - rust-install

- name: Set Rust home directory
  ansible.builtin.set_fact:
    rust_home_dir: "{{ rust_home | default(rust_user_home_result.stdout, true) }}"
  tags:
    - rust
    - rust-install

- name: Check if rustc is installed
  ansible.builtin.command:
    cmd: which rustc
  register: rust_rustc_check
  changed_when: false
  failed_when: false
  tags:
    - rust
    - rust-install

- name: Skip Rust installation if already installed
  ansible.builtin.debug:
    msg: "rustc is already installed. Skipping Rust installation."
  when: rust_rustc_check.rc == 0
  tags:
    - rust
    - rust-install

- name: Get Ubuntu version
  ansible.builtin.shell: |
    set -o pipefail
    grep '^VERSION_ID=' /etc/os-release | cut -d'=' -f2 | tr -d '"'
  args:
    executable: /bin/bash
  register: rust_ubuntu_version
  changed_when: false
  when:
    - rust_rustc_check.rc != 0
    - rust_install_method == "auto" or rust_install_method == "apt"
  tags:
    - rust
    - rust-install

- name: Determine Rust installation method
  ansible.builtin.set_fact:
    rust_install_method_final: >-
      {%- if rust_install_method == "auto" -%}
        {%- if rust_ubuntu_version.stdout == "24.04" -%}apt{%- else -%}rustup{%- endif -%}
      {%- else -%}
        {{ rust_install_method }}
      {%- endif -%}
  when:
    - rust_rustc_check.rc != 0
    - rust_install | bool
  tags:
    - rust
    - rust-install

- name: Install Rust via rustup (Ubuntu 22.04 or manual)
  when:
    - rust_rustc_check.rc != 0
    - rust_install | bool
    - rust_install_method_final == "rustup"
  tags:
    - rust
    - rust-install
  block:
    - name: Download rustup installer
      ansible.builtin.get_url:
        url: https://sh.rustup.rs
        dest: /tmp/rustup-init.sh
        mode: '0755'

    - name: Check if Rust is already installed
      ansible.builtin.stat:
        path: "{{ rust_home_dir }}/.cargo/bin/rustc"
      register: rust_rustc_installed_check
      changed_when: false

    - name: Install Rust via rustup
      ansible.builtin.shell: |
        bash /tmp/rustup-init.sh -y
      environment:
        HOME: "{{ rust_home_dir }}"
      become: true
      become_user: "{{ rust_user }}"
      when: not rust_rustc_installed_check.stat.exists
      register: rust_rust_install
      changed_when: rust_rust_install.rc == 0

    - name: Clean up rustup installer
      ansible.builtin.file:
        path: /tmp/rustup-init.sh
        state: absent

- name: Install Rust via apt (Ubuntu 24.04)
  when:
    - rust_rustc_check.rc != 0
    - rust_install | bool
    - rust_install_method_final == "apt"
  tags:
    - rust
    - rust-install
  block:
    - name: Install rustup package
      ansible.builtin.apt:
        name: rustup
        state: present
        update_cache: true

    - name: Check current default Rust toolchain
      ansible.builtin.shell: |
        set -o pipefail
        rustup show default 2>/dev/null | grep -q "{{ rust_default_toolchain }}" || echo "not_{{ rust_default_toolchain }}"
      args:
        executable: /bin/bash
      environment:
        HOME: "{{ rust_home_dir }}"
        PATH: "{{ ansible_facts['env']['PATH'] | default('/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin', true) }}"
      become: true
      become_user: "{{ rust_user }}"
      register: rust_rustup_default_check
      changed_when: false
      failed_when: false

    - name: Set default Rust toolchain
      ansible.builtin.shell: |
        rustup default {{ rust_default_toolchain }}
      environment:
        HOME: "{{ rust_home_dir }}"
        PATH: "{{ ansible_facts['env']['PATH'] | default('/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin', true) }}"
      become: true
      become_user: "{{ rust_user }}"
      when: "('not_' ~ rust_default_toolchain) in rust_rustup_default_check.stdout"
      register: rust_rustup_default
      changed_when: rust_rustup_default.rc == 0

- name: Verify Rust installation
  ansible.builtin.command:
    cmd: rustc --version
  environment:
    HOME: "{{ rust_home_dir }}"
    PATH: "{{ ansible_facts['env']['PATH'] | default('/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin', true) }}:{{ rust_home_dir }}/.cargo/bin"
  register: rust_verify
  changed_when: false
  failed_when: rust_verify.rc != 0
  tags:
    - rust
    - rust-install
