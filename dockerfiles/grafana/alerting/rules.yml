apiVersion: 1

groups:
  - orgId: 1
    name: broker-alerts
    folder: Broker
    interval: 5m
    rules:
      - uid: broker-error-spike
        title: Broker Error Spike
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: Loki
            model:
              expr: 'count_over_time({compose_service="broker"} |~ "ERROR" [5m])'
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: reduce
              expression: A
              reducer: last
              refId: B
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: B
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 10
              refId: C
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Broker error spike detected"
          description: "More than 10 ERROR log lines in the last 5 minutes from the broker service."

      - uid: broker-low-collateral
        title: "Low Collateral Balance"
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: Loki
            model:
              expr: 'count_over_time({compose_service="broker"} |~ "\\[B-BAL-STK\\]" [5m])'
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: reduce
              expression: A
              reducer: last
              refId: B
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: B
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 0
              refId: C
        for: 0s
        labels:
          severity: critical
        annotations:
          summary: "Collateral balance below threshold"
          description: "Broker collateral (stake) balance has dropped below the configured threshold. Orders may be skipped due to insufficient collateral."

      - uid: broker-low-eth
        title: "Low ETH Balance"
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: Loki
            model:
              expr: 'count_over_time({compose_service="broker"} |~ "\\[B-BAL-ETH\\]" [5m])'
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: reduce
              expression: A
              reducer: last
              refId: B
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: B
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 0
              refId: C
        for: 0s
        labels:
          severity: critical
        annotations:
          summary: "ETH balance below threshold"
          description: "Broker ETH balance has dropped below the configured threshold. Transaction submissions may fail."

      - uid: broker-fatal-stake-at-risk
        title: "FATAL: Stake At Risk"
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: Loki
            model:
              expr: 'count_over_time({compose_service="broker"} |~ "FATAL STAKE AT RISK" [5m])'
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: reduce
              expression: A
              reducer: last
              refId: B
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: B
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 0
              refId: C
        for: 0s
        labels:
          severity: critical
        annotations:
          summary: "FATAL: Stake is at risk of slashing"
          description: "An order failed to transition from locking to proving status. Locked stake may be slashed if the order is not fulfilled."

      - uid: broker-insufficient-balance-committed
        title: "Insufficient Balance for Committed Orders"
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: Loki
            model:
              expr: 'count_over_time({compose_service="broker"} |~ "Insufficient balance for committed orders" [5m])'
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: reduce
              expression: A
              reducer: last
              refId: B
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: B
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 0
              refId: C
        for: 0s
        labels:
          severity: critical
        annotations:
          summary: "ETH balance too low for committed orders"
          description: "The broker does not have enough ETH to cover gas costs for orders it has already committed to. Immediate top-up required."

      - uid: broker-batch-submission-failed
        title: "Batch Submission Failed"
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: Loki
            model:
              expr: 'count_over_time({compose_service="broker"} |~ "Batch submission failed|has reached max submission attempts" [5m])'
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: reduce
              expression: A
              reducer: last
              refId: B
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: B
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 0
              refId: C
        for: 0s
        labels:
          severity: warning
        annotations:
          summary: "Batch submission failure"
          description: "A proof batch failed to submit on-chain or exhausted all retry attempts."

      - uid: broker-proving-failure
        title: "Order Proving Failure"
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: Loki
            model:
              expr: 'count_over_time({compose_service="broker"} |~ "failed to prove after" [5m])'
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: reduce
              expression: A
              reducer: last
              refId: B
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: B
              conditions:
                - evaluator:
                    type: gt
                    params:
                      - 0
              refId: C
        for: 0s
        labels:
          severity: warning
        annotations:
          summary: "Order failed to prove"
          description: "An order exhausted all proving retries and failed."
